<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Deploying Lyft's Presto Gateway on Google Cloud with helm - Home</title><meta name=description content="Lyft&rsquo;s gateway project is a popular open source solution for a gateway that can be deployed in front of multiple Trino clusters. Lyft has more information on how it works in a blog post on their engineering blog.
I wanted to deploy this solution on Google Kubernetes Engine but I could not find any docker image or helm charts available. The instructions for deployment did not cover this deployment method either."><meta name=author content><link rel="preload stylesheet" as=style href=https://posulliv.github.io/app.min.css><link rel="preload stylesheet" as=style href=https://posulliv.github.io/an-old-hope.min.css><script defer src=https://posulliv.github.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://posulliv.github.io/theme.png><link rel=preload as=image href=https://posulliv.github.io/twitter.svg><link rel=preload as=image href=https://posulliv.github.io/github.svg><link rel=icon href=https://posulliv.github.io/favicon.ico><link rel=apple-touch-icon href=https://posulliv.github.io/apple-touch-icon.png><meta name=generator content="Hugo 0.96.0"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-RB870JF93J","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RB870JF93J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-RB870JF93J",{anonymize_ip:!1})}</script><meta property="og:title" content="Deploying Lyft's Presto Gateway on Google Cloud with helm"><meta property="og:description" content="Lyft&rsquo;s gateway project is a popular open source solution for a gateway that can be deployed in front of multiple Trino clusters. Lyft has more information on how it works in a blog post on their engineering blog.
I wanted to deploy this solution on Google Kubernetes Engine but I could not find any docker image or helm charts available. The instructions for deployment did not cover this deployment method either."><meta property="og:type" content="article"><meta property="og:url" content="https://posulliv.github.io/posts/lyft-gateway-helm/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-12T08:53:46-04:00"><meta property="article:modified_time" content="2022-04-12T08:53:46-04:00"><meta itemprop=name content="Deploying Lyft's Presto Gateway on Google Cloud with helm"><meta itemprop=description content="Lyft&rsquo;s gateway project is a popular open source solution for a gateway that can be deployed in front of multiple Trino clusters. Lyft has more information on how it works in a blog post on their engineering blog.
I wanted to deploy this solution on Google Kubernetes Engine but I could not find any docker image or helm charts available. The instructions for deployment did not cover this deployment method either."><meta itemprop=datePublished content="2022-04-12T08:53:46-04:00"><meta itemprop=dateModified content="2022-04-12T08:53:46-04:00"><meta itemprop=wordCount content="1140"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploying Lyft's Presto Gateway on Google Cloud with helm"><meta name=twitter:description content="Lyft&rsquo;s gateway project is a popular open source solution for a gateway that can be deployed in front of multiple Trino clusters. Lyft has more information on how it works in a blog post on their engineering blog.
I wanted to deploy this solution on Google Kubernetes Engine but I could not find any docker image or helm charts available. The instructions for deployment did not cover this deployment method either."></head><body class=not-ready data-menu=false><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-RB870JF93J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-RB870JF93J",{anonymize_ip:!1})}</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-RB870JF93J","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><header class=header><p class=logo><a class=site-name href=https://posulliv.github.io/>Home</a><a class=btn-dark></a></p><script>let bodyClx=document.body.classList,btnDark=document.querySelector(".btn-dark"),sysDark=window.matchMedia("(prefers-color-scheme: dark)"),darkVal=localStorage.getItem("dark"),setDark=e=>{bodyClx[e?"add":"remove"]("dark"),localStorage.setItem("dark",e?"yes":"no")};setDark(darkVal?darkVal==="yes":sysDark.matches),requestAnimationFrame(()=>bodyClx.remove("not-ready")),btnDark.addEventListener("click",()=>setDark(!bodyClx.contains("dark"))),sysDark.addEventListener("change",e=>setDark(e.matches))</script><nav class=social><a class=twitter style=--url:url(./twitter.svg) href=https://twitter.com/posulliv target=_blank></a>
<a class=github style=--url:url(./github.svg) href=https://github.com/posulliv target=_blank></a></nav></header><main class=main><article class=post-single><header class=post-title><p><time>Apr 12, 2022</time></p><h1>Deploying Lyft's Presto Gateway on Google Cloud with helm</h1></header><section class=post-content><p>Lyft&rsquo;s <a href=https://github.com/lyft/presto-gateway>gateway project</a> is a popular
open source solution for a gateway that can be deployed in front of multiple
Trino clusters. Lyft has more information on how it works in a <a href=https://eng.lyft.com/presto-infrastructure-at-lyft-b10adb9db01>blog post</a>
on their engineering blog.</p><p>I wanted to deploy this solution on Google Kubernetes Engine but I could not
find any docker image or helm charts available. The instructions for deployment
did not cover this deployment method either.</p><p>Thus, I created a docker image and a helm chart for the project. You can see the source for
the helm chart and scripts I used to create the docker image in <a href=https://github.com/posulliv/lyft-gateway-charts>my github repository</a>.</p><p>In this post, I&rsquo;m going to cover how to use the helm chart to deploy a Trino
gateway on Google Kubernetes Engine.</p><h1 id=configure-chart-repository>Configure chart repository</h1><p>The first thing we need to do is add the chart repository that contains my
helm chart for Lyft&rsquo;s gatway:</p><pre tabindex=0><code>helm repo add gateway https://posulliv.github.io/lyft-gateway-charts
helm repo update
</code></pre><h1 id=deploy-mysql>Deploy MySQL</h1><p>The only prerequisite to using Lyft&rsquo;s gateway is a MySQL database. For this
article, I am going to deploy a temporary MySQL database in my kubernetes
cluster. This is not a recommended approach for a production deployment
as the MySQL database is a single point of failure for the gateway. If the
gateway cannot connect to a MySQL database, it will cease to function correctly.</p><p>With that said, here is the values I will use for deploying MySQL in my
kubernetes cluster:</p><pre tabindex=0><code>auth:
  database: gateway
  rootPassword: root

primary:
  service:
    type: LoadBalancer
    port: 3306
</code></pre><p>Now I am going to deploy MySQL via <code>helm</code>:</p><pre tabindex=0><code>helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
helm install mysql bitnami/mysql --values mysql.yaml
curl -LJO https://raw.githubusercontent.com/lyft/presto-gateway/master/gateway-ha/src/main/resources/gateway-ha-persistence.sql
mysql -h $mysql_ip -u root -proot gateway &lt; gateway-ha-persistence.sql
</code></pre><p>Notice that I retrieved a SQL file with the schema needed by Lyft&rsquo;s gateway
from the github repository for the project. I also referenced <code>$mysql_ip</code> in
the above command. This will be the external IP of the MySQL database since I
deployed with a <code>LoadBalancer</code>. It may take some time for an external IP to be
assigned.</p><h1 id=deploy-multiple-gateway-pods>Deploy multiple gateway pods</h1><p>Now we are ready to deploy Lyft&rsquo;s gateway. The nice thing about deploying on
a kubernetes platform is I can easily deploy multiple gateway pods. The helm
chart has support for this by simply specifying how many pods are needed in
the <code>replicaCount</code> parameter.</p><p>Below is the YAML I am going to use for deploying the gateway.</p><pre tabindex=0><code>image:
  repository: posulliv/gateway
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: latest

replicaCount: 4

backendDatabase:
  host: mysql
  port: 3306
  schema: gateway
  user: root
  password: root

service:
  type: NodePort
  requestPort: 8080
  appPort: 8090
  adminPort: 8091
</code></pre><p>Now, we can deploy this via <code>helm</code>:</p><pre tabindex=0><code>helm install trino-gateway gateway/gateway --version 0.2.6 --values gateway.yaml
</code></pre><p>Once this completes, we should have 4 gateway pods running:</p><pre tabindex=0><code>NAME                            READY   STATUS    RESTARTS   AGE
mysql-0                         1/1     Running   0          15h
trino-gateway-65bd4689f-69zfg   1/1     Running   0          72s
trino-gateway-65bd4689f-bqt4h   1/1     Running   0          72s
trino-gateway-65bd4689f-gcv6b   1/1     Running   0          72s
trino-gateway-65bd4689f-jsszh   1/1     Running   0          72s
</code></pre><h1 id=expose-gateway-via-an-ingress>Expose gateway via an ingress</h1><p>The gateway service was exposed via <code>NodePort</code> and we are now going to create
an ingress for it.</p><p>First we need to create a static IP address:</p><pre tabindex=0><code>gcloud compute addresses create gateway-static-ip --global
</code></pre><p>Now, we can create an ingress and associate the static IP address we created
with it:</p><pre tabindex=0><code>apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gateway-ingress
  annotations:
    kubernetes.io/ingress.global-static-ip-name: &#34;gateway-static-ip&#34;
spec:
  defaultBackend:
    service:
      name: trino-gateway
      port:
        number: 8080
</code></pre><p>We will deploy this with <code>kubectl</code>:</p><pre tabindex=0><code>kubectl apply -f ingress.yaml
</code></pre><p>Finally, we need to configure a DNS A record for the static IP we created.</p><p>Once the DNS record is created, we can access the gateway via the DNS record
we created.</p><p>If we open the gateway URL in a web browser, we should now see the gateway UI.</p><p><img src=/img/gateway_notls_ui.png alt="Gateway web UI"></p><h1 id=add-some-trino-clusters>Add some trino clusters</h1><p>Let&rsquo;s now deploy 2 single node Trino clusters with <code>helm</code>. For a more in-depth
guide to deploy Trino on helm, please see <a href=https://posulliv.github.io/posts/trino-helm/>my earlier post</a>
on the topic.</p><p>For this post, we are going to use the same YAML for both Trino clusters:</p><pre tabindex=0><code>server:
  node:
    environment: gateway
  workers: 0

service:
  type: LoadBalancer
</code></pre><p>We will deploy 2 Trino clusters:</p><pre tabindex=0><code>helm install trino-a trino/trino --version 0.8.0 --values trino.yaml
helm install trino-b trino/trino --version 0.8.0 --values trino.yaml
</code></pre><p>We should now have 2 Trino single node deployments:</p><pre tabindex=0><code>trino-a-coordinator-745c8875dc-vf6cp   1/1     Running   0          41s
trino-b-coordinator-77976bdbdd-d7zzv   1/1     Running   0          33s
</code></pre><p>Now, we can add these clusters as backends using the gateway&rsquo;s REST API:</p><pre tabindex=0><code>curl -X POST http://trino-gateway.starburst-customer-success.com/entity\?entityType=GATEWAY_BACKEND \
-d &#39;{  &#34;name&#34;: &#34;trino-a&#34;,
        &#34;proxyTo&#34;: &#34;http://trino_a_ip:8080&#34;,
        &#34;active&#34;: true,
        &#34;routingGroup&#34;: &#34;adhoc&#34;
    }&#39;
curl -X POST http://trino-gateway.starburst-customer-success.com/entity\?entityType=GATEWAY_BACKEND \
-d &#39;{  &#34;name&#34;: &#34;trino-b&#34;,
        &#34;proxyTo&#34;: &#34;http://trino_b_ip:8080&#34;,
        &#34;active&#34;: true,
        &#34;routingGroup&#34;: &#34;adhoc&#34;
    }&#39;
</code></pre><p>Once the above <code>curl</code> commands complete, we should see 2 backends in the
gateway web UI.</p><p><img src=/img/gateway_backends.png alt="Gateway backends"></p><p>We should also be able to connect via the Trino CLI and execute queries.</p><pre tabindex=0><code>$ trino --server http://trino-gateway.starburst-customer-success.com --user padraig
trino&gt; show catalogs;
 Catalog
---------
 system
 tpcds
 tpch
(3 rows)

Query 20220412_013906_00000_5q4vw, FINISHED, 1 node
Splits: 4 total, 4 done (100.00%)
2.87 [0 rows, 0B] [0 rows/s, 0B/s]

trino&gt;
</code></pre><h1 id=tls-termination-at-gateway>TLS termination at gateway</h1><p>Now we want to enable TLS and terminate it at the ingress that is in front of
our gateway.</p><p>Since we are deploying on Google Cloud, we will use <a href=https://cloud.google.com/load-balancing/docs/ssl-certificates/google-managed-certs>Google Managed Certificates</a>
for enabling TLS to the gateway.</p><p>The first thing we need to do is create a managed certificate with the DNS
record we configured for the static IP we created. We will place the following
in a <code>managed-cert.yaml</code> file:</p><pre tabindex=0><code>apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: managed-cert
spec:
  domains:
    - trino-gateway.starburst-customer-success.com
</code></pre><p>And we will deploy it with <code>kubectl</code>:</p><pre tabindex=0><code>kubectl apply -f managed-cert.yaml
</code></pre><p>It can take up to 60 minutes to provision a managed certificate on the
Google Cloud Platform. Once it is provisioned, it should show a status of
<code>Active</code>:</p><pre tabindex=0><code>$ kubectl get managedcertificate
NAME           AGE   STATUS
managed-cert   47h   Active
$
</code></pre><p>Now we are ready to modify our ingress. We will put the following in an
<code>ingress.yaml</code> file:</p><pre tabindex=0><code>apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gateway-ingress
  annotations:
    kubernetes.io/ingress.global-static-ip-name: &#34;gateway-static-ip&#34;
    networking.gke.io/managed-certificates: managed-cert
    kubernetes.io/ingress.class: &#34;gce&#34;
spec:
  defaultBackend:
    service:
      name: trino-gateway
      port:
        number: 8080
</code></pre><p>Now we should be able to access the gateway web UI via TLS with a valid
certificate:</p><p><img src=/img/gateway_tls_ui.png alt="Gateway tls web UI"></p><p>Now, we can connect to the gateway from our client tools using TLS. For example,
if using the Trino CLI:</p><pre tabindex=0><code>$ trino --server https://trino-gateway.starburst-customer-success.com --user bob
trino&gt; show catalogs;
 Catalog
---------
 system
 tpcds
 tpch
(3 rows)

Query 20220412_131551_00001_isuvu, FINISHED, 1 node
Splits: 4 total, 4 done (100.00%)
0.37 [0 rows, 0B] [0 rows/s, 0B/s]

trino&gt;
</code></pre><h1 id=conclusion>Conclusion</h1><p>I hope this article proves useful for someone as I could not find much
information on deploying Lyft&rsquo;s gateway on a kubernetes platform.</p><p>I did not cover how to deploy this gateway with end-to-end encryption
between the client, gateway, and backend Trino clusters. I hope to
cover this in a future article.</p></section><nav class=post-nav><a class=next href=https://posulliv.github.io/posts/trino-helm/><span>Deploying Trino on Google Cloud with helm</span><span>→</span></a></nav></article></main><footer class=footer><p>&copy; 2022 <a href=https://posulliv.github.io/>Home</a></p><p>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</p><p><a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper 5.1</a></p></footer></body></html>